"use client";

import FcmInit from "@/components/FcmInit";
import { siteKeyAtom } from "@/lib/atoms/siteKeyAtom";
import { db } from "@/lib/firebase";
import {
  addDoc,
  collection,
  doc,
  getDocs,
  onSnapshot,
  orderBy,
  query,
  runTransaction,
  serverTimestamp,
  where,
} from "firebase/firestore";
import { useAtomValue } from "jotai";
import Image from "next/image";
import { useEffect, useMemo, useRef, useState } from "react";

const ALL_SECTIONS = "__ALL__";

/* ---------- Âûã ---------- */
type Product = {
  productId: number;
  name: string;
  price: number;
  imageUri: string;
  soldOut?: boolean;
  description?: string;
  taxIncluded?: boolean;
  docId: string;
  sectionId?: string | null; // ‚Üê ËøΩÂä†Ôºö„Çª„ÇØ„Ç∑„Éß„É≥Á¥ê‰ªò„Åë
};

type Section = {
  id: string; // sections „ÅÆ doc.id
  name: string;
  sortIndex: number;
};

type MyOrder = {
  orderNo: number;
  docId: string;
  notified: boolean;
  totalItems: number;
  waitMinutes?: number;
};

/* ---------- „Éò„É´„Éë ---------- */
async function getNextOrderNoForSite(siteKey: string): Promise<number> {
  const ref = doc(db, "counters", siteKey);
  const next = await runTransaction(db, async (tx) => {
    const snap = await tx.get(ref);
    const curr = (snap.data()?.current as number) ?? 0;
    const val = curr + 1;
    tx.set(ref, { current: val }, { merge: true });
    return val;
  });
  return next;
}

export default function MenuPage() {
  const siteKey = useAtomValue(siteKeyAtom);

  const [products, setProducts] = useState<Product[]>([]);
  const [sections, setSections] = useState<Section[]>([]); // ‚Üê ËøΩÂä†
  const [selectedSectionId, setSelectedSectionId] =
    useState<string>(ALL_SECTIONS);

  const [qty, setQty] = useState<Record<number, number>>({});
  const [activeOrders, setActiveOrders] = useState<any[]>([]);
  const [currentNo, setCurrentNo] = useState(0);
  // const [waitTimeText, setWaitTimeText] = useState("ÁèæÂú®„ÅÆÂæÖ„Å°ÊôÇÈñì: 0ÂàÜ");

  const [myOrders, setMyOrders] = useState<MyOrder[]>([]);
  const [lastOrderNo, setLastOrderNo] = useState<number | null>(null);
  const [completedOrderNo, setCompletedOrderNo] = useState<number | null>(null);

  const [confirmOpen, setConfirmOpen] = useState(false);
  const [doneOpen, setDoneOpen] = useState(false);
  const [finishOpen, setFinishOpen] = useState(false);
  const [submitting, setSubmitting] = useState(false);
  const [productsReady, setProductsReady] = useState(false);
  const [isOpen, setIsOpen] = useState<boolean | null>(null);

  const [notifSupported, setNotifSupported] = useState(false);
  const [notifGranted, setNotifGranted] = useState(false);
  const [askNotif, setAskNotif] = useState(false);

  const localKey = siteKey ? `myOrders:${siteKey}` : "myOrders";

  const displayProducts = useMemo(() => {
    if (sections.length === 0 || selectedSectionId === ALL_SECTIONS)
      return products;
    return products.filter((p) => p.sectionId === selectedSectionId);
  }, [products, sections, selectedSectionId]);

  // „Éû„Ç¶„É≥„ÉàÊôÇ„Å´„Çµ„Éù„Éº„Éà/Ë®±ÂèØÁä∂Ê≥Å„ÇíÂèçÊò†
  useEffect(() => {
    const ok = typeof window !== "undefined" && "Notification" in window;
    setNotifSupported(ok);
    if (ok) setNotifGranted(Notification.permission === "granted");
  }, []);

  // „ÇØ„É™„ÉÉ„ÇØ„ÅßÈÄöÁü•Ë®±ÂèØ„Çí„É™„ÇØ„Ç®„Çπ„Éà
  const enableNotifications = async () => {
    try {
      const res = await Notification.requestPermission();
      const granted = res === "granted";
      setNotifGranted(granted);
      if (!granted)
        alert("ÈÄöÁü•„ÅåË®±ÂèØ„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ");
    } catch (e) {
      console.error(e);
    }
  };

  // ÂÆüÈöõ„Å´ÈÄöÁü•„ÇíÂá∫„Åô„Éò„É´„Éë
  const notifyUser = (orderNo: number) => {
    try {
      if (notifSupported && Notification.permission === "granted") {
        const n = new Notification("„ÅîÊ≥®Êñá„Åå„Åß„Åç„ÅÇ„Åå„Çä„Åæ„Åó„ÅüÔºÅ", {
          body: `Ê≥®ÊñáÁï™Âè∑: ${orderNo} „Çí„ÅäÂèó„ÅëÂèñ„Çä„Åè„Å†„Åï„ÅÑ`,
          tag: `order-${orderNo}`, // Âêå„Åò„Çø„Ç∞„ÅØÁΩÆ„ÅçÊèõ„Åà„Çâ„Çå„Çã
          // renotify: true, // ‚Üê Â§ñ„Åô
        });
        n.onclick = () => window.focus();
      } else {
        document.title = `üîî Ê≥®Êñá ${orderNo} ÂÆåÊàêÔºÅ`;
        try {
          (navigator as any).vibrate?.(200);
        } catch {}
      }
    } catch (e) {
      console.error(e);
    }
  };

  // isOpen Ë≥ºË™≠
  useEffect(() => {
    if (!siteKey) {
      setIsOpen(true);
      return;
    }
    const ref = doc(db, "siteSettingsEditable", siteKey);
    return onSnapshot(
      ref,
      (snap) => {
        const data = snap.data() as { isOpen?: boolean } | undefined;
        setIsOpen(data?.isOpen ?? true);
      },
      (e) => {
        console.error("isOpen onSnapshot error:", e);
        setIsOpen(true);
      }
    );
  }, [siteKey]);

  /* ---------- ÂàùÂõûÂæ©ÂÖÉ / ÂÜçË°®Á§∫Âæ©ÂÖÉ ---------- */
  useEffect(() => {
    try {
      const saved = localStorage.getItem(localKey);
      if (saved) setMyOrders(JSON.parse(saved));
    } catch {}
    const onVis = () => {
      if (document.visibilityState === "visible") {
        try {
          const saved = localStorage.getItem(localKey);
          if (saved) setMyOrders(JSON.parse(saved));
        } catch {}
      }
    };
    document.addEventListener("visibilitychange", onVis);
    return () => document.removeEventListener("visibilitychange", onVis);
  }, [localKey]);

  /* ---------- „Çª„ÇØ„Ç∑„Éß„É≥Ë≥ºË™≠ ---------- */
  useEffect(() => {
    if (!siteKey) return;
    const qy = query(
      collection(db, "sections"),
      where("siteKey", "==", siteKey),
      orderBy("sortIndex", "asc")
    );
    return onSnapshot(
      qy,
      (snap) => {
        const arr: Section[] = snap.docs.map((d, i) => {
          const v = d.data() as any;
          return {
            id: d.id,
            name: String(v.name ?? ""),
            sortIndex:
              typeof v.sortIndex === "number" ? v.sortIndex : (i + 1) * 1000,
          };
        });
        setSections(arr);

        // „Çª„ÇØ„Ç∑„Éß„É≥„ÅåÁÑ°„ÅÑ or Êó¢Â≠òÈÅ∏Êäû„ÅåÊ∂à„Åà„Åü„Çâ„ÄåÂÖ®„Çª„ÇØ„Ç∑„Éß„É≥„Äç„Å´Êàª„Åô
        if (
          arr.length === 0 ||
          (selectedSectionId !== ALL_SECTIONS &&
            !arr.some((s) => s.id === selectedSectionId))
        ) {
          setSelectedSectionId(ALL_SECTIONS);
        }
      },
      (err) => console.error("sections onSnapshot error:", err)
    );
  }, [siteKey, selectedSectionId]);

  /* ---------- ÂïÜÂìÅ‰∏ÄË¶ßÔºà‰∏¶„Å≥È†Ü sortIndex ÂÑ™ÂÖàÔºâ ---------- */
  useEffect(() => {
    if (!siteKey) return;

    setProductsReady(false);

    const qy = query(
      collection(db, "products"),
      where("siteKey", "==", siteKey),
      orderBy("sortIndex", "asc"),
      orderBy("productId", "asc")
    );

    const unsub = onSnapshot(
      qy,
      (snap) => {
        const list: Product[] = snap.docs.map((d) => {
          const v = d.data() as any;
          return {
            productId: Number(v.productId ?? 0),
            name: String(v.name ?? ""),
            price: Number(v.price ?? 0),
            imageUri: String(v.imageUri ?? ""),
            soldOut: Boolean(v.soldOut ?? false),
            description: v.description ? String(v.description) : "",
            taxIncluded: v.taxIncluded == null ? true : Boolean(v.taxIncluded),
            docId: d.id,
            sectionId: typeof v.sectionId === "string" ? v.sectionId : null,
          };
        });

        setProducts(list);

        setQty((prev) => {
          const next = { ...prev };
          list.forEach((p) => {
            if (next[p.productId] == null) next[p.productId] = 0;
          });
          return next;
        });

        setProductsReady(true);
      },
      (err) => {
        console.error("products onSnapshot error:", err);
        setProductsReady(true);
      }
    );

    return () => unsub();
  }, [siteKey]);

  /* ---------- Êú™ÂÆå‰∫ÜÊ≥®Êñá„ÅÆË≥ºË™≠ÔºàÂæÖ„Å°ÊôÇÈñì / ÁèæÂú®Áï™Âè∑Ôºâ ---------- */
  useEffect(() => {
    const qy = query(
      collection(db, "orders"),
      where("siteKey", "==", siteKey),
      where("isComp", "==", false),
      orderBy("orderNo", "asc")
    );
    return onSnapshot(qy, (snap) => {
      if (snap.empty) {
        setActiveOrders([]);
        setCurrentNo(0);
        // setWaitTimeText("ÁèæÂú®„ÅÆÂæÖ„Å°ÊôÇÈñì: 0ÂàÜ");
        return;
      }
      const list = snap.docs.map((d) => d.data());
      setActiveOrders(list);
      setCurrentNo(list[0]?.orderNo ?? 0);

      const totalItemsAll = list.reduce(
        (s: number, o: any) => s + (o.totalItems || 0),
        0
      );
      // const mins = totalItemsAll * 5;
      // setWaitTimeText(
      //   `ÁèæÂú®„ÅÆÂæÖ„Å°ÊôÇÈñì: Á¥Ñ${Math.floor(mins / 60)}ÊôÇÈñì${mins % 60}ÂàÜ`
      // );
    });
  }, [siteKey]);

  /* ---------- activeOrders Â§âÂåñ„Åß MyOrder „ÅÆÂæÖ„Å°ÊôÇÈñìÊõ¥Êñ∞ ---------- */
  useEffect(() => {
    if (!activeOrders.length || !myOrders.length) return;
    const updated = myOrders.map((mo) => {
      const before = activeOrders.filter((o: any) => o.orderNo < mo.orderNo);
      const itemsBefore = before.reduce(
        (s: number, o: any) => s + (o.totalItems || 0),
        0
      );
      const selfItems =
        activeOrders.find((o: any) => o.orderNo === mo.orderNo)?.totalItems ??
        mo.totalItems;
      return { ...mo, waitMinutes: itemsBefore * 5 + selfItems * 5 };
    });
    setMyOrders(updated);
    localStorage.setItem(localKey, JSON.stringify(updated));
  }, [activeOrders, myOrders.length, localKey]);

  /* ---------- Ëá™ÂàÜ„ÅÆÊ≥®ÊñáÂÆå‰∫ÜÈÄöÁü• ---------- */
  useEffect(() => {
    if (!myOrders.length) return;
    const unsubs = myOrders.map((mo) => {
      const ref = doc(db, "orders", mo.docId);
      return onSnapshot(ref, (snap) => {
        const data = snap.data();
        if (data?.isComp && !mo.notified) {
          setCompletedOrderNo(mo.orderNo);
          setFinishOpen(true);
          setMyOrders((prev) => {
            const next = prev
              .map((x) =>
                x.orderNo === mo.orderNo ? { ...x, notified: true } : x
              )
              .filter((x) => x.orderNo !== mo.orderNo);
            localStorage.setItem(localKey, JSON.stringify(next));
            return next;
          });
        }
      });
    });
    return () => unsubs.forEach((u) => u());
  }, [myOrders, localKey]);

  useEffect(() => {
    if (!myOrders.length) return;
    const unsubs = myOrders.map((mo) => {
      const ref = doc(db, "orders", mo.docId);
      return onSnapshot(ref, (snap) => {
        const data = snap.data();
        if (data?.isComp && !mo.notified) {
          // ‚òÖ ÈÄöÁü•„ÇíÂá∫„Åô
          notifyUser(mo.orderNo);

          setCompletedOrderNo(mo.orderNo);
          setFinishOpen(true);
          setMyOrders((prev) => {
            const next = prev
              .map((x) =>
                x.orderNo === mo.orderNo ? { ...x, notified: true } : x
              )
              .filter((x) => x.orderNo !== mo.orderNo);
            localStorage.setItem(localKey, JSON.stringify(next));
            return next;
          });
        }
      });
    });
    return () => unsubs.forEach((u) => u());
  }, [myOrders, localKey, notifSupported]);

  /* ---------- ÂêàË®à ---------- */
  const totalItems = useMemo(
    () => Object.values(qty).reduce((a, b) => a + b, 0),
    [qty]
  );
  const totalPrice = useMemo(
    () => products.reduce((s, p) => s + p.price * (qty[p.productId] || 0), 0),
    [products, qty]
  );

  /* ---------- „Ç§„Éô„É≥„Éà ---------- */
  const openConfirm = () => {
    if (isOpen === false) {
      alert("ÁèæÂú®„ÅØ„ÇØ„É≠„Éº„Ç∫‰∏≠„Åß„Åô„ÄÇÊôÇÈñì„Çí„Åä„ÅÑ„Å¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ");
      return;
    }
    if (totalItems === 0) {
      alert("Êï∞Èáè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
      return;
    }
    setConfirmOpen(true);
  };

  const confirmOrder = async () => {
    setSubmitting(true);
    setConfirmOpen(false);
    try {
      const key = siteKey;
      if (!key) {
        alert(
          "Â∫óËàó„Ç≥„Éº„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„Éà„ÉÉ„Éó„Å´Êàª„Å£„Å¶QR„ÇíË™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ"
        );
        return;
      }

      // ‚òÖ „Åì„Åì„Åß„Éà„Éº„ÇØ„É≥„ÇíÂèñÂæó
      const fcmToken =
        typeof window !== "undefined" ? localStorage.getItem("fcmToken") : null;

      // ÁèæÂú®„ÅÆÊú™ÂÆå‰∫ÜÊ≥®Êñá„ÇíÂèñÂæóÔºàÂæÖ„Å°ÊôÇÈñì„Å™„Å©„ÅÆË®àÁÆóÁî®Ôºâ
      const snap = await getDocs(
        query(
          collection(db, "orders"),
          where("siteKey", "==", key),
          where("isComp", "==", false),
          orderBy("orderNo", "asc")
        )
      );
      const current = snap.docs.map((d) => d.data());

      // Êé°Áï™
      const orderNo = await getNextOrderNoForSite(key);

      // Ê≥®Êñá„Ç¢„Ç§„ÉÜ„É†„Çí‰ΩúÊàê
      const items = products
        .filter((p) => (qty[p.productId] || 0) > 0)
        .map((p) => ({
          productId: p.productId,
          name: p.name,
          price: p.price,
          quantity: qty[p.productId] || 0,
          subtotal: p.price * (qty[p.productId] || 0),
        }));

      if (items.length === 0) {
        alert("Êï∞Èáè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
        return;
      }

      const totalItemsLocal = items.reduce((s, it) => s + it.quantity, 0);
      const totalPriceLocal = items.reduce((s, it) => s + it.subtotal, 0);

      const itemsBefore = current.reduce(
        (s: number, o: any) => s + (o.totalItems || 0),
        0
      );
      const waitMin = itemsBefore * 5 + totalItemsLocal * 5;

      // ‚òÖ Ê≥®Êñá‰øùÂ≠òÊôÇ„Å´ customerFcmToken „Çí‰∏ÄÁ∑í„Å´‰øùÂ≠ò
      const ref = await addDoc(collection(db, "orders"), {
        siteKey: key,
        orderNo,
        items,
        totalItems: totalItemsLocal,
        totalPrice: totalPriceLocal,
        isComp: false,
        createdAt: serverTimestamp(),
        customerFcmToken: fcmToken ?? null, // ‚Üê ËøΩÂä†
      });

      // „É≠„Éº„Ç´„É´„ÅÆËá™ÂàÜ„ÅÆÊ≥®ÊñáÊÉÖÂ†±„ÇíÊõ¥Êñ∞
      const newMy: MyOrder = {
        orderNo,
        docId: ref.id,
        notified: false,
        totalItems: totalItemsLocal,
        waitMinutes: waitMin,
      };
      setLastOrderNo(orderNo);
      setMyOrders((prev) => {
        const next = [...prev, newMy];
        localStorage.setItem(localKey, JSON.stringify(next));
        return next;
      });

      // „Ç´„Éº„Éà„Çí„É™„Çª„ÉÉ„Éà & ÂÆå‰∫Ü„É¢„Éº„ÉÄ„É´
      setQty(Object.fromEntries(products.map((p) => [p.productId, 0])));
      setDoneOpen(true);
    } catch (e) {
      console.error(e);
      alert("‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÈÄö‰ø°Áä∂Ê≥Å„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ");
    } finally {
      setSubmitting(false);
    }
  };

  // ÂÖàÈ†≠„ÅÆ„É≠„Éº„Éá„Ç£„É≥„Ç∞Âà§ÂÆö
  if (!productsReady) {
    return (
      <main className="min-h-[100dvh] grid place-items-center px-4">
        <div className="h-8 w-8 animate-spin rounded-full border-2 border-gray-300 border-t-transparent" />
      </main>
    );
  }

  /* ---------- UI ---------- */
  if (productsReady && products.length === 0) {
    return (
      <main className="min-h-[100dvh] grid place-items-center px-4">
        <p className="text-sm text-gray-600">
          „Åì„ÅÆÂ∫óËàó„Å´„ÅØ„Åæ„Å†ÂïÜÂìÅ„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ
          ÁÆ°ÁêÜÁîªÈù¢„Åã„ÇâÂïÜÂìÅ„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
        </p>
      </main>
    );
  }

  return (
    <main className="mx-auto max-w-md px-3 pb-28 pt-4">
      {isOpen === false && (
        <div className="fixed inset-0 z-[1000] bg-black/70 backdrop-blur-sm grid place-items-center">
          <p className="text-white text-6xl md:text-8xl font-extrabold tracking-widest select-none">
            CLOSE
          </p>
        </div>
      )}

      {!siteKey ? (
        <div className="min-h-[60vh] grid place-items-center px-4">
          <p className="text-sm text-gray-600">
            Â∫óËàó„Ç≥„Éº„Éâ„ÅåÊú™Ë®≠ÂÆö„Åß„Åô„ÄÇ„Éà„ÉÉ„Éó„Å´Êàª„Å£„Å¶ QR „ÇíË™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ
          </p>
        </div>
      ) : (
        <>
          {/* „Éò„ÉÉ„ÉÄ„ÉºÔºàÁèæÂú®Áï™Âè∑ & ÂæÖ„Å°ÊôÇÈñìÔºâ */}
          <div className="rounded-md bg-gradient-to-r from-teal-500 to-pink-500 p-3 text-white shadow">
            {currentNo > 0 ? (
              <>
                <div className="flex items-center justify-center gap-2 text-[17px] font-bold">
                  <span>ÁèæÂú®‰ΩúÊàê‰∏≠„ÅÆÊ≥®ÊñáÁï™Âè∑:</span>
                  <span>{currentNo}</span>
                </div>
                {/* <p className="mt-1 text-center font-bold">{waitTimeText}</p> */}
              </>
            ) : (
              <p className="py-3 text-center text-[17px] font-bold">
                „Åô„Åê„Å´„Åä‰Ωú„Çä„Åß„Åç„Åæ„ÅôÔºÅ
              </p>
            )}
          </div>

          {notifSupported && !notifGranted && (
            <>
              <button
                type="button"
                onClick={() => setAskNotif(true)}
                className="w-full rounded-md border px-3 py-2 text-sm"
              >
                üîî ÂÆåÊàêÊôÇ„Å´ÈÄöÁü•„ÇíÂèó„ÅëÂèñ„ÇãÔºàÈÄöÁü•„ÇíONÔºâ
              </button>

              {/* „Éú„Çø„É≥Êäº‰∏ãÊôÇ„Å´„Å†„ÅëËµ∞„Çã */}
              <FcmInit
                run={askNotif}
                onToken={() => {
                  setNotifGranted(true);
                  setAskNotif(false); // 1ÂõûËµ∞„Å£„Åü„ÇâÂÅúÊ≠¢
                }}
              />
            </>
          )}

          {/* „Çª„ÇØ„Ç∑„Éß„É≥„Éî„ÉÉ„Ç´„ÉºÔºà„Çª„ÇØ„Ç∑„Éß„É≥„Åå„ÅÇ„Çã„Å®„Åç„Å†„ÅëË°®Á§∫Ôºâ */}
          {sections.length > 0 && (
            <div className="mt-3">
              <label className="block text-sm mb-1">„Çª„ÇØ„Ç∑„Éß„É≥</label>
              <select
                value={selectedSectionId}
                onChange={(e) => setSelectedSectionId(e.target.value)}
                className="h-10 w-full rounded-md border px-2"
              >
                <option value={ALL_SECTIONS}>ÂÖ®„Çª„ÇØ„Ç∑„Éß„É≥</option>
                {/* ‚Üê ËøΩÂä† */}
                {sections.map((s) => (
                  <option key={s.id} value={s.id}>
                    {s.name}
                  </option>
                ))}
              </select>
            </div>
          )}

          {/* Ëá™ÂàÜ„ÅÆÊ≥®ÊñáÁä∂Ê≥ÅÔºà„É≠„Éº„Ç´„É´Ôºâ */}
          <div className="mt-2 space-y-2">
            {myOrders.map((o) => {
              const remaining = Math.max(o.orderNo - currentNo, 0);
              return (
                <div key={o.orderNo} className="rounded-md bg-blue-50 p-2">
                  <p className="text-teal-700">
                    „ÅîÊ≥®ÊñáÁï™Âè∑ {o.orderNo} „ÅØ
                    {remaining === 0
                      ? "ÁèæÂú®„Åä‰Ωú„Çä„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ"
                      : remaining === 1
                      ? "Ê¨°„Åß„Åô„ÄÇ"
                      : `„ÅÇ„Å® ${remaining} Áï™ÁõÆ„Åß„Åô`}
                  </p>
                  {remaining > 0 && (
                    <p className="text-sm text-gray-600">
                      Á¥Ñ {o.waitMinutes ?? 0} ÂàÜ„Åª„Å©„ÅßÂá∫Êù•‰∏ä„Åå„Çä„Åæ„Åô
                    </p>
                  )}
                </div>
              );
            })}
          </div>

          {/* ÂïÜÂìÅ‰∏ÄË¶ßÔºö2Âàó„Ç∞„É™„ÉÉ„Éâ */}
          <div className="mt-6 grid grid-cols-2 gap-6">
            {displayProducts.map((p) => {
              const count = qty[p.productId] || 0;
              return (
                <div key={p.docId} className="rounded-md bg-white shadow-sm">
                  <div className="relative aspect-square w-full overflow-hidden rounded-t-md">
                    <Image
                      src={p.imageUri}
                      alt={p.name}
                      fill
                      className="object-cover"
                      sizes="(max-width: 640px) 50vw, 240px"
                    />
                    {p.soldOut && (
                      <div className="absolute left-0 top-0 z-10 h-7 w-full bg-red-600/90 text-center text-xs font-bold text-white">
                        <span className="leading-7">SOLD OUT</span>
                      </div>
                    )}
                  </div>

                  <div className="p-2">
                    <p className="line-clamp-1 text-sm font-semibold">
                      {p.name}
                    </p>
                    <p className="text-xs text-gray-600">
                      Ôø•{p.price.toLocaleString("ja-JP")}
                      {p.taxIncluded ? "(Á®éËæº)" : "(Á®éÊäú)"}
                    </p>

                    {p.description && (
                      <p className="mt-1 line-clamp-2 whitespace-pre-wrap break-words text-xs text-gray-700">
                        {p.description}
                      </p>
                    )}

                    <div className="mt-2 flex items-center justify-between">
                      <button
                        type="button"
                        className="inline-flex h-8 w-8 items-center justify-center rounded-md border bg-gray-50 text-base disabled:opacity-40"
                        onClick={() =>
                          setQty((q) => ({
                            ...q,
                            [p.productId]: Math.max(
                              0,
                              (q[p.productId] || 0) - 1
                            ),
                          }))
                        }
                        disabled={p.soldOut || count <= 0}
                      >
                        Ôºç
                      </button>
                      <div className="w-10 select-none text-center text-sm">
                        {count}
                      </div>
                      <button
                        type="button"
                        className="inline-flex h-8 w-8 items-center justify-center rounded-md border bg-gray-50 text-base disabled:opacity-40"
                        onClick={() =>
                          setQty((q) => ({
                            ...q,
                            [p.productId]: (q[p.productId] || 0) + 1,
                          }))
                        }
                        disabled={p.soldOut}
                      >
                        Ôºã
                      </button>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>

          {/* „Éï„ÉÉ„Çø„ÉºÊ≥®Êñá„Éê„Éº */}
          <div className="fixed inset-x-0 bottom-0 z-40 bg-white px-4 py-3 shadow-[0_-4px_12px_rgba(0,0,0,0.06)]">
            <div className="mx-auto flex max-w-md items-center justify-between">
              <div className="flex items-center gap-2">
                <div className="grid h-10 w-10 place-items-center rounded-full border">
                  üõí
                </div>
                {totalItems > 0 && (
                  <>
                    <span className="font-bold">{totalItems} ÁÇπ</span>
                    <span className="text-gray-600">
                      / Ôø•{totalPrice.toLocaleString("ja-JP")}
                    </span>
                  </>
                )}
              </div>
              <button
                onClick={openConfirm}
                disabled={submitting || isOpen === false}
                className="rounded-md bg-teal-600 px-4 py-2 font-medium text-white disabled:opacity-50"
              >
                Ê≥®Êñá„Åô„Çã
              </button>
            </div>
          </div>

          {/* Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´ */}
          {confirmOpen && (
            <Modal onClose={() => setConfirmOpen(false)} title="Ê≥®ÊñáÂÜÖÂÆπ„ÅÆÁ¢∫Ë™ç">
              <div className="space-y-2">
                {products
                  .filter((p) => (qty[p.productId] || 0) > 0)
                  .map((p) => (
                    <div
                      key={p.docId}
                      className="flex items-center justify-between text-sm"
                    >
                      <span>{p.name}</span>
                      <span>
                        {qty[p.productId]}√óÔø•{p.price}ÔºùÔø•
                        {(qty[p.productId] * p.price).toLocaleString("ja-JP")}
                      </span>
                    </div>
                  ))}
              </div>
              <p className="mt-4 text-right text-base font-semibold">
                ÂêàË®à Ôø•{totalPrice.toLocaleString("ja-JP")}
              </p>
              <div className="mt-4 flex gap-2">
                <button
                  className="flex-1 rounded-md border px-3 py-2"
                  onClick={() => setConfirmOpen(false)}
                >
                  „Ç≠„É£„É≥„Çª„É´
                </button>
                <button
                  className="flex-1 rounded-md bg-teal-600 px-3 py-2 text-white"
                  onClick={confirmOrder}
                >
                  Á¢∫ÂÆö
                </button>
              </div>
            </Modal>
          )}

          {/* Ê≥®ÊñáÂÆå‰∫Ü„É¢„Éº„ÉÄ„É´ */}
          {doneOpen && (
            <Modal onClose={() => setDoneOpen(false)} title="Ê≥®ÊñáÂÆå‰∫ÜÔºÅ">
              <p className="mb-2 text-center">Ê≥®Êñá„ÇíÂèó„Åë‰ªò„Åë„Åæ„Åó„ÅüÔºÅ</p>
              <div className="my-2 text-center">
                <div className="text-sm">Ê≥®ÊñáÁï™Âè∑:</div>
                <div className="text-4xl font-bold text-teal-600">
                  {lastOrderNo}
                </div>
              </div>
              <p className="mt-2 text-center text-sm">
                ÁîªÈù¢„Çí„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà„Åó„Å¶„Çπ„Çø„ÉÉ„Éï„Å´„ÅäË¶ã„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ
              </p>
              <button
                className="mt-4 w-full rounded-md bg-teal-600 px-3 py-2 text-white"
                onClick={() => setDoneOpen(false)}
              >
                Èñâ„Åò„Çã
              </button>
            </Modal>
          )}

          {/* ÂÆåÊàêÈÄöÁü•„É¢„Éº„ÉÄ„É´ */}
          {finishOpen && (
            <Modal
              onClose={() => setFinishOpen(false)}
              title="„ÅîÊ≥®Êñá„ÅÆÂïÜÂìÅ„Åå„Åß„Åç„ÅÇ„Åå„Çä„Åæ„Åó„ÅüÔºÅ"
            >
              <div className="text-center text-3xl font-bold text-teal-700">
                Ê≥®ÊñáÁï™Âè∑: {completedOrderNo}
              </div>
              <p className="mt-3 text-center text-sm">
                „Çπ„Çø„ÉÉ„Éï„Å´„Åì„ÅÆÁï™Âè∑„Çí„ÅäË¶ã„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ
              </p>
              <button
                className="mt-4 w-full rounded-md bg-teal-600 px-3 py-2 text-white"
                onClick={() => setFinishOpen(false)}
              >
                Èñâ„Åò„Çã
              </button>
            </Modal>
          )}
        </>
      )}
    </main>
  );
}

/* ---------- „Ç∑„É≥„Éó„É´„Å™„É¢„Éº„ÉÄ„É´ ---------- */
function Modal({
  title,
  children,
  onClose,
}: {
  title: string;
  children: React.ReactNode;
  onClose: () => void;
}) {
  const overlayRef = useRef<HTMLDivElement | null>(null);

  useEffect(() => {
    const onKey = (e: KeyboardEvent) => {
      if (e.key === "Escape") onClose();
    };
    document.addEventListener("keydown", onKey);
    return () => document.removeEventListener("keydown", onKey);
  }, [onClose]);

  return (
    <div
      ref={overlayRef}
      className="fixed inset-0 z-50 grid place-items-center bg-black/50 px-4"
      onClick={(e) => {
        if (e.target === overlayRef.current) onClose();
      }}
    >
      <div className="w-full max-w-md rounded-md bg-white p-4 shadow-lg">
        <div className="mb-3">
          <h2 className="text-lg font-semibold">{title}</h2>
        </div>
        {children}
      </div>
    </div>
  );
}
